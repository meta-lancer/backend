name: Build with Gradle
run-name: Go Go
on:
  push:
    branches:
      - main

env:
  AWS_REGION: ap-northeast-2
  AWS_S3_BUCKET: metaovis-service
  AWS_CODE_DEPLOY_APPLICATION: Backend-CICD
  AWS_CODE_DEPLOY_GROUP: Backend-CICD-Group
  RESOURCE_PATH: ./src/main/resources/application.yml

jobs:
  build-with-gradle:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          ref: main
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'corretto'

      - name: Set yml file
        uses: microsoft/variable-substitution@v1
        with:
          files: ${{ env.RESOURCE_PATH }}
        env:
          spring.redis.host: ${}
          spring.redis.port: ${}
          spring.security.oauth2.client.targetUrl: ${}
          spring.loginPage: ${}
          spring.successUrl: ${}
          spring.failUrl: ${}
          spring.security.rememberMe.key: ${}
          exchange.api.key: ${}
          cloud.aws.credentials.accessKey: ${}
          cloud.aws.credentials.secretKey: ${}
          cloud.aws.s3.assetBucket: ${}
          cloud.aws.region.static: ${}
          cloud.aws.s3.cloudfront.asset: ${}
          cloud.aws.s3.cloudfront.user: ${}
          cloud.aws.s3.cloudfront.service: ${}
          slack.private.token: ${}
          slack.channel.error: ${}
          slack.channel.info: ${}
          iamport.api.key: ${}
          iamport.api.secret: ${}
          iamport.imp_uid: ${}
          spring.datasource.driver-class-name: ${{ secrets.RDS_HOST }}
          spring.datasource.url: ${{ secrets.RDS_HOST }}
          spring.datasource.username: ${{ secrets.RDS_USERNAME }}
          spring.datasource.password: ${{ secrets.RDS_PASSWORD }}

      - name: Where is here
        run: pwd

      - name: Executable Gradle
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew clean build --stacktrace

      - name: AWS credential 설정
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ env.AWS_REGION }}
          aws-access-key-id: ${{ secrets.CICD_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.CICD_SECRET_KEY }}

      - name: S3에 업로드
        run: aws deploy push --application-name ${{ env.AWS_CODE_DEPLOY_APPLICATION }} --ignore-hidden-files --s3-location s3://$AWS_S3_BUCKET/cicdtest/$GITHUB_SHA.zip --source .
      - name: EC2에 배포
        run: aws deploy create-deployment --application-name ${{ env.AWS_CODE_DEPLOY_APPLICATION }} --deployment-config-name CodeDeployDefault.AllAtOnce --deployment-group-name ${{ env.AWS_CODE_DEPLOY_GROUP }} --s3-location bucket=$AWS_S3_BUCKET,key=cicdtest/$GITHUB_SHA.zip,bundleType=zip